{% extends 'budget/base.html' %}
{% block content %}
<h2>Přehled rozpočtu</h2>
<p><strong>Aktuální zůstatek:</strong> {{ balance }} Kč</p>
<p><strong>Celkové příjmy:</strong> {{ total_income }} Kč</p>
<p><strong>Celkové výdaje:</strong> {{ total_expense }} Kč</p>

<!-- Místo pro grafy -->
<div class="row">
  <!-- První graf: Přehled financí (koláčový graf) -->
  <div class="col-md-6">
    <div class="card mb-3">
      <div class="card-header">
        Přehled financí
      </div>
      <div class="card-body">
        <div style="width: 200px; height: 200px; margin: 0;">
          <canvas id="financeChart" width="200" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Druhý graf: Sloupcový graf srovnání měsíčních financí -->
  <div class="col-md-6">
    <div class="card mb-3">
      <div class="card-header">
        Srovnání měsíčních financí
      </div>
      <div class="card-body">
        <div style="width: 200px; height: 200px; margin: 0;">
          <canvas id="otherChart" width="200" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Akční tlačítka: Přidat transakci, Zobrazit všechny transakce a Kalkulačka -->
<div class="my-3 d-flex align-items-center">
    <a href="{% url 'add_transaction' %}" class="btn btn-success me-2">Přidat transakci</a>
    <div class="btn-group">
        <a href="{% url 'transaction_list' %}" class="btn btn-info">Zobrazit všechny transakce</a>
        <button id="calculatorBtn" class="btn btn-primary" type="button"
                data-bs-toggle="collapse" data-bs-target="#calculator"
                aria-expanded="false" aria-controls="calculator">
            Kalkulačka
        </button>
    </div>
</div>

<!-- Kalkulačka (skrytá pomocí collapse) -->
<div class="collapse mt-3" id="calculator">
  <div class="card card-body calculator-container">
    <div id="calc-display" class="mb-3">
      <input type="text" id="calc-result" class="form-control" placeholder="0" readonly>
    </div>
    <div class="calculator-buttons">
      <div class="btn-group d-flex flex-wrap">
        <button class="btn btn-light calc-btn" value="7">7</button>
        <button class="btn btn-light calc-btn" value="8">8</button>
        <button class="btn btn-light calc-btn" value="9">9</button>
        <button class="btn btn-secondary calc-btn" value="/">/</button>
        <button class="btn btn-light calc-btn" value="4">4</button>
        <button class="btn btn-light calc-btn" value="5">5</button>
        <button class="btn btn-light calc-btn" value="6">6</button>
        <button class="btn btn-secondary calc-btn" value="*">*</button>
        <button class="btn btn-light calc-btn" value="1">1</button>
        <button class="btn btn-light calc-btn" value="2">2</button>
        <button class="btn btn-light calc-btn" value="3">3</button>
        <button class="btn btn-secondary calc-btn" value="-">-</button>
        <button class="btn btn-light calc-btn" value="0">0</button>
        <button class="btn btn-light calc-btn" value=".">.</button>
        <button class="btn btn-danger" id="calc-clear">C</button>
        <button class="btn btn-secondary calc-btn" value="+">+</button>
      </div>
      <div class="mt-2">
        <button class="btn btn-success w-100" id="calc-equals">=</button>
      </div>
    </div>
  </div>
</div>

<h3>Poslední transakce</h3>
<table class="table table-striped">
    <thead>
        <tr>
            <th>Datum</th>
            <th>Kategorie</th>
            <th>Částka</th>
            <th>Poznámka</th>
        </tr>
    </thead>
    <tbody>
        {% for t in transactions %}
        <tr>
            <td>{{ t.date }}</td>
            <td>{{ t.category.name }}</td>
            <td>{{ t.amount }} Kč</td>
            <td>{{ t.note }}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="4">Žádné transakce</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}

{% block extra_scripts %}
  {{ block.super }}
  <!-- Uložení dat do HTML pomocí json_script -->
  <script id="monthly-labels" type="application/json">
      {{ monthly_labels|json_script:"monthlyLabels" }}
  </script>
  <script id="monthly-data" type="application/json">
      {{ monthly_data|json_script:"monthlyData" }}
  </script>

  <!-- Inicializace grafů -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Inicializace prvního grafu (koláčový graf: Přehled financí)
      var financeCanvas = document.getElementById('financeChart');
      if (financeCanvas) {
        var financeCtx = financeCanvas.getContext('2d');
        new Chart(financeCtx, {
          type: 'pie',
          data: {
            labels: ['Příjmy', 'Výdaje'],
            datasets: [{
              data: [{{ total_income }}, {{ total_expense }}],
              backgroundColor: ['#28a745', '#dc3545']
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'bottom' }
            }
          }
        });
      }

      // Inicializace druhého grafu (sloupcový graf: Srovnání měsíčních financí)
      var otherCanvas = document.getElementById('otherChart');
      if (otherCanvas) {
        var otherCtx = otherCanvas.getContext('2d');
        // Načtení dat ze skriptových elementů a jejich převod pomocí JSON.parse
        var monthlyLabels = JSON.parse(document.getElementById('monthly-labels').textContent);
        var monthlyData = JSON.parse(document.getElementById('monthly-data').textContent);
        console.log("Monthly Labels:", monthlyLabels);
        console.log("Monthly Data:", monthlyData);  // Pro ladění

        new Chart(otherCtx, {
          type: 'bar',
          data: {
            labels: monthlyLabels,
            datasets: [{
              label: 'Celkové transakce',
              data: monthlyData,
              backgroundColor: 'rgba(54, 162, 235, 0.5)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'bottom' }
            },
            scales: {
              y: { beginAtZero: true }
            }
          }
        });
      }
    });
  </script>

  <!-- Vaše další skripty (např. kalkulačka) zůstávají beze změny -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const calcResult = document.getElementById('calc-result');
      const calcButtons = document.querySelectorAll('.calc-btn');
      const calcClear = document.getElementById('calc-clear');
      const calcEquals = document.getElementById('calc-equals');

      let expression = '';

      // Přidání akcí ke všem tlačítkům s čísly a operátory
      calcButtons.forEach(button => {
        button.addEventListener('click', function () {
          expression += this.value;
          calcResult.value = expression;
        });
      });

      // Vymazání výrazu
      calcClear.addEventListener('click', function () {
        expression = '';
        calcResult.value = '';
      });

      // Vyhodnocení výrazu
      calcEquals.addEventListener('click', function () {
        try {
          const result = eval(expression);
          calcResult.value = result;
          expression = result.toString();
        } catch (error) {
          calcResult.value = 'Error';
          expression = '';
        }
      });
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const calcResult = document.getElementById('calc-result');
      const calcButtons = document.querySelectorAll('.calc-btn');
      const calcClear = document.getElementById('calc-clear');
      const calcEquals = document.getElementById('calc-equals');
      let expression = '';

      calcButtons.forEach(button => {
          button.addEventListener('click', function () {
              expression += this.value;
              calcResult.value = expression;
          });
      });

      calcClear.addEventListener('click', function () {
          expression = '';
          calcResult.value = '';
      });

      calcEquals.addEventListener('click', function () {
          try {
              const result = eval(expression);
              calcResult.value = result;
              expression = result.toString();
          } catch (error) {
              calcResult.value = 'Error';
              expression = '';
          }
      });

      // Podpora pro klávesnici
      document.addEventListener('keydown', function (event) {
          const allowedKeys = "0123456789.+-*/";
          if (allowedKeys.includes(event.key)) {
              expression += event.key;
              calcResult.value = expression;
          } else if (event.key === "Enter") {
              try {
                  const result = eval(expression);
                  calcResult.value = result;
                  expression = result.toString();
              } catch (error) {
                  calcResult.value = 'Error';
                  expression = '';
              }
              event.preventDefault();
          } else if (event.key === "Backspace") {
              expression = expression.slice(0, -1);
              calcResult.value = expression;
              event.preventDefault();
          } else if (event.key === "Escape") {
              expression = '';
              calcResult.value = '';
          }
      });
    });
  </script>
{% endblock extra_scripts %}


