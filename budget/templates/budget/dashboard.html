{% extends 'budget/base.html' %}
{% load static %}

{% block content %}
<h2>Přehled rozpočtu</h2>
<p><strong>Aktuální zůstatek:</strong> {{ balance }} Kč</p>
<p><strong>Celkové příjmy:</strong> {{ total_income }} Kč</p>
<p><strong>Celkové výdaje:</strong> {{ total_expense }} Kč</p>

<!-- Místo pro grafy -->
<div class="row">
  <!-- První graf: Přehled financí (koláčový graf) -->
  <div class="col-md-6">
    <div class="card mb-3">
      <div class="card-header">Přehled financí</div>
      <div class="card-body text-center">
        <canvas id="financeChart" width="200" height="200"></canvas>
      </div>
    </div>
  </div>

  <!-- Druhý graf: Sloupcový graf srovnání měsíčních financí -->
  <div class="col-md-6">
    <div class="card mb-3">
      <div class="card-header">Srovnání měsíčních financí</div>
      <div class="card-body text-center">
        <canvas id="otherChart" width="200" height="200"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Akční tlačítka: Přidat transakci, Zobrazit všechny transakce a Kalkulačka -->
<div class="my-3 d-flex align-items-center">
  <a href="{% url 'add_transaction' %}" class="btn btn-success me-2">Přidat transakci</a>
  <div class="btn-group">
    <a href="{% url 'transaction_list' %}" class="btn btn-info">Zobrazit všechny transakce</a>
    <button id="calculatorBtn" class="btn btn-primary" type="button"
            data-bs-toggle="collapse" data-bs-target="#calculator"
            aria-expanded="false" aria-controls="calculator">
      Kalkulačka
    </button>
  </div>
</div>

<!--kalkulačka -->
<div class="collapse mt-3" id="calculator">
  <div class="row justify-content-start">
    <div class="col-md-6">
      <div class="card shadow-lg p-3 mb-5 bg-light rounded">
        <div class="card-body">
          <!-- Displej kalkulačky -->
          <div id="calc-display" class="mb-3">
            <input type="text" id="calc-result" class="form-control text-end fs-3" placeholder="0" readonly style="height: 60px;">
          </div>
          <!-- Tlačítka kalkulačky -->
          <div class="calculator-buttons">
            <div class="row g-2">
              <div class="col-3">
                <button class="btn btn-outline-secondary calc-btn w-100 py-3" value="7">7</button>
              </div>
              <div class="col-3">
                <button class="btn btn-outline-secondary calc-btn w-100 py-3" value="8">8</button>
              </div>
              <div class="col-3">
                <button class="btn btn-outline-secondary calc-btn w-100 py-3" value="9">9</button>
              </div>
              <div class="col-3">
                <button class="btn btn-warning calc-btn w-100 py-3" value="/">÷</button>
              </div>

              <div class="col-3">
                <button class="btn btn-outline-secondary calc-btn w-100 py-3" value="4">4</button>
              </div>
              <div class="col-3">
                <button class="btn btn-outline-secondary calc-btn w-100 py-3" value="5">5</button>
              </div>
              <div class="col-3">
                <button class="btn btn-outline-secondary calc-btn w-100 py-3" value="6">6</button>
              </div>
              <div class="col-3">
                <button class="btn btn-warning calc-btn w-100 py-3" value="*">×</button>
              </div>

              <div class="col-3">
                <button class="btn btn-outline-secondary calc-btn w-100 py-3" value="1">1</button>
              </div>
              <div class="col-3">
                <button class="btn btn-outline-secondary calc-btn w-100 py-3" value="2">2</button>
              </div>
              <div class="col-3">
                <button class="btn btn-outline-secondary calc-btn w-100 py-3" value="3">3</button>
              </div>
              <div class="col-3">
                <button class="btn btn-warning calc-btn w-100 py-3" value="-">−</button>
              </div>

              <div class="col-3">
                <button class="btn btn-outline-secondary calc-btn w-100 py-3" value="0">0</button>
              </div>
              <div class="col-3">
                <button class="btn btn-outline-secondary calc-btn w-100 py-3" value=".">.</button>
              </div>
              <div class="col-3">
                <button class="btn btn-danger calc-clear w-100 py-3" id="calc-clear">C</button>
              </div>
              <div class="col-3">
                <button class="btn btn-warning calc-btn w-100 py-3" value="+">+</button>
              </div>

              <div class="col-12 mt-2">
                <button class="btn btn-success w-100 py-3" id="calc-equals">=</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<h3>Poslední transakce</h3>
<table class="table table-striped">
  <thead>
    <tr>
      <th>Datum</th>
      <th>Kategorie</th>
      <th>Částka</th>
      <th>Poznámka</th>
    </tr>
  </thead>
  <tbody>
    {% for t in transactions %}
    <tr>
      <td>{{ t.date }}</td>
      <td>{{ t.category.name }}</td>
      <td>{{ t.amount }} Kč</td>
      <td>{{ t.note }}</td>
    </tr>
    {% empty %}
    <tr>
      <td colspan="4">Žádné transakce</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock content %}

{% block extra_scripts %}
  {{ block.super }}

  {# Uložení dat do HTML pomocí json_script #}
  {{ monthly_labels|json_script:"monthly-labels" }}
  {{ monthly_data|json_script:"monthly-data" }}


  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Inicializace grafů -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Koláčový graf: Přehled financí
      var financeCanvas = document.getElementById('financeChart');
      if (financeCanvas) {
        var financeCtx = financeCanvas.getContext('2d');
        new Chart(financeCtx, {
          type: 'pie',
          data: {
            labels: ['Příjmy', 'Výdaje'],
            datasets: [{
              data: [{{ total_income }}, {{ total_expense }}],
              backgroundColor: ['#28a745', '#dc3545']
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { position: 'bottom' } }
          }
        });
      }

      // Sloupcový graf: Srovnání měsíčních financí
      var otherCanvas = document.getElementById('otherChart');
      if (otherCanvas) {
        var otherCtx = otherCanvas.getContext('2d');
        var monthlyLabels = JSON.parse(document.getElementById('monthly-labels').textContent);
        var monthlyData = JSON.parse(document.getElementById('monthly-data').textContent);
        new Chart(otherCtx, {
          type: 'bar',
          data: {
            labels: monthlyLabels,
            datasets: [{
              label: 'Celkové transakce',
              data: monthlyData,
              backgroundColor: 'rgba(54, 162, 235, 0.5)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { position: 'bottom' } },
            scales: { y: { beginAtZero: true } }
          }
        });
      }
    });
  </script>

  <!-- Styl pro kalkulačku – Animace stisku tlačítek -->
  <style>
    .calc-btn.active-btn {
      transform: scale(0.95);
      transition: transform 0.1s ease-in-out;
    }
  </style>

  <!-- Funkcionalita kalkulačky -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const calcResult = document.getElementById('calc-result');
      const calcButtons = document.querySelectorAll('.calc-btn');
      const calcClear = document.getElementById('calc-clear');
      const calcEquals = document.getElementById('calc-equals');
      let expression = '';

      function updateDisplay() {
        calcResult.value = expression || "0";
      }

      // Akce pro tlačítka kalkulačky
      calcButtons.forEach(btn => {
        btn.addEventListener('click', function () {
          this.classList.add('active-btn');
          setTimeout(() => this.classList.remove('active-btn'), 100);
          expression += this.value;
          updateDisplay();
        });
      });

      // Clear tlačítko
      calcClear.addEventListener('click', function () {
        expression = '';
        updateDisplay();
      });

      // Vyhodnocení výrazu
      calcEquals.addEventListener('click', function () {
        try {
          const result = eval(expression);
          expression = result.toString();
          updateDisplay();
        } catch (error) {
          calcResult.value = 'Error';
          expression = '';
        }
      });

      // Podpora klávesnice
      document.addEventListener('keydown', function (event) {
        const allowedKeys = "0123456789.+-*/";
        if (allowedKeys.includes(event.key)) {
          expression += event.key;
          updateDisplay();
        } else if (event.key === "Enter") {
          try {
            const result = eval(expression);
            expression = result.toString();
            updateDisplay();
          } catch (error) {
            calcResult.value = 'Error';
            expression = '';
          }
          event.preventDefault();
        } else if (event.key === "Backspace") {
          expression = expression.slice(0, -1);
          updateDisplay();
          event.preventDefault();
        } else if (event.key === "Escape") {
          expression = '';
          updateDisplay();
        }
      });
    });
  </script>
{% endblock extra_scripts %}





